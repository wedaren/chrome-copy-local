name: Release Chrome Extension

# è§¦å‘æ¡ä»¶
on:
  # å½“æ¨é€æ ‡ç­¾æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆå¦‚ï¼šv1.0.0ï¼‰
  push:
    tags:
      - 'v*'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š1.0.1ï¼‰'
        required: true
        default: '1.0.1'
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜'
        required: false
        default: 'Bug fixes and improvements'

# å¹¶å‘æ§åˆ¶ï¼Œç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªå‘å¸ƒä»»åŠ¡è¿è¡Œ
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—
      
      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          # å®‰è£…ç”¨äºæ‰“åŒ…å’Œå‘å¸ƒçš„å·¥å…·
          npm install -g chrome-webstore-upload-cli
      
      # 4. æ£€æµ‹ç‰ˆæœ¬å·
      - name: æ£€æµ‹ç‰ˆæœ¬å·
        id: version
        run: |
          if [[ ${{ github.event_name }} == 'push' ]]; then
            # ä» Git æ ‡ç­¾è·å–ç‰ˆæœ¬å·
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "ä»æ ‡ç­¾è·å–ç‰ˆæœ¬: $VERSION"
          elif [[ ${{ github.event_name }} == 'workflow_dispatch' ]]; then
            # ä»æ‰‹åŠ¨è¾“å…¥è·å–ç‰ˆæœ¬å·
            VERSION="${{ github.event.inputs.version }}"
            echo "æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬: $VERSION"
          else
            echo "æ— æ³•ç¡®å®šç‰ˆæœ¬å·"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      
      # 5. æ›´æ–° manifest.json ç‰ˆæœ¬å·
      - name: æ›´æ–°æ‰©å±•ç‰ˆæœ¬å·
        run: |
          # ä½¿ç”¨ jq æ›´æ–° manifest.json ä¸­çš„ç‰ˆæœ¬å·
          jq --arg version "$VERSION" '.version = $version' manifest.json > manifest.tmp
          mv manifest.tmp manifest.json
          
          echo "å·²æ›´æ–° manifest.json ç‰ˆæœ¬å·ä¸º: $VERSION"
          cat manifest.json | jq '.version'
      
      # 6. è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœæœ‰ï¼‰
      - name: è¿è¡Œæµ‹è¯•
        run: |
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test
          else
            echo "æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•è„šæœ¬ï¼Œè·³è¿‡æµ‹è¯•"
          fi
      
      # 7. æ„å»ºæ‰©å±•åŒ…
      - name: æ„å»ºæ‰©å±•åŒ…
        run: |
          # åˆ›å»ºæ„å»ºç›®å½•
          mkdir -p dist
          
          # å¤åˆ¶æ‰©å±•æ–‡ä»¶åˆ°æ„å»ºç›®å½•ï¼ˆæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
          cp -r . dist/extension
          cd dist/extension
          
          # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
          rm -rf node_modules
          rm -rf .git
          rm -rf .github
          rm -rf dist
          rm -f package*.json
          rm -f server.js
          rm -f *.md
          rm -f .gitignore
          rm -f *.ipynb
          rm -rf captured
          
          # åˆ›å»º ZIP åŒ…
          cd ..
          zip -r extension.zip extension/
          
          echo "æ‰©å±•åŒ…å·²åˆ›å»º: dist/extension.zip"
          ls -la extension.zip
      
      # 8. éªŒè¯æ‰©å±•åŒ…
      - name: éªŒè¯æ‰©å±•åŒ…
        run: |
          cd dist
          unzip -l extension.zip | head -20
          
          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if unzip -l extension.zip | grep -q "manifest.json"; then
            echo "âœ“ manifest.json å­˜åœ¨"
          else
            echo "âœ— manifest.json ä¸å­˜åœ¨"
            exit 1
          fi
          
          if unzip -l extension.zip | grep -q "popup.html"; then
            echo "âœ“ popup.html å­˜åœ¨"
          else
            echo "âœ— popup.html ä¸å­˜åœ¨"
            exit 1
          fi
      
      # 9. ä¸Šä¼ åˆ° Chrome Web Store
      - name: å‘å¸ƒåˆ° Chrome Web Store
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          EXTENSION_ID: ${{ secrets.EXTENSION_ID }}
        run: |
          echo "å¼€å§‹ä¸Šä¼ æ‰©å±•åˆ° Chrome Web Store..."
          
          # ä½¿ç”¨ chrome-webstore-upload-cli ä¸Šä¼ 
          npx chrome-webstore-upload-cli upload \
            --source dist/extension.zip \
            --extension-id $EXTENSION_ID \
            --client-id $GOOGLE_CLIENT_ID \
            --client-secret $GOOGLE_CLIENT_SECRET \
            --refresh-token $GOOGLE_REFRESH_TOKEN \
            --auto-publish
      
      # 10. åˆ›å»º GitHub Release
      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "DOM Catcher v${{ env.VERSION }}"
          body: |
            ## ğŸš€ DOM Catcher v${{ env.VERSION }}
            
            ### ğŸ“¦ æ›´æ–°å†…å®¹
            ${{ github.event.inputs.release_notes || 'æœ¬æ¬¡æ›´æ–°åŒ…å«åŠŸèƒ½æ”¹è¿›å’Œé”™è¯¯ä¿®å¤ã€‚' }}
            
            ### ğŸ“‹ å®‰è£…æ–¹å¼
            1. **ä» Chrome Web Store å®‰è£…**ï¼ˆæ¨èï¼‰
               - è®¿é—® [Chrome Web Store](https://chrome.google.com/webstore/detail/${{ secrets.EXTENSION_ID }})
               - ç‚¹å‡»"æ·»åŠ è‡³ Chrome"
            
            2. **æ‰‹åŠ¨å®‰è£…**
               - ä¸‹è½½ä¸‹æ–¹çš„ `extension.zip` æ–‡ä»¶
               - è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
               - åœ¨ Chrome ä¸­æ‰“å¼€ `chrome://extensions/`
               - å¼€å¯"å¼€å‘è€…æ¨¡å¼"
               - ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
               - é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
            
            ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
            1. é…ç½®æœåŠ¡å™¨åœ°å€ï¼ˆé»˜è®¤ï¼šhttp://localhost:3000ï¼‰
            2. æµ‹è¯•æœåŠ¡å™¨è¿æ¥çŠ¶æ€
            3. ç‚¹å‡»"å¼€å§‹é€‰æ‹©å…ƒç´ "æ•è·ç½‘é¡µå†…å®¹
            
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            æŸ¥çœ‹ [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/è‡ªå®šä¹‰æœåŠ¡å™¨åŠŸèƒ½è¯´æ˜.md)
            
            ---
            **ç‰ˆæœ¬ä¿¡æ¯**
            - æ„å»ºæ—¶é—´: ${{ github.run_id }}
            - æäº¤: ${{ github.sha }}
          files: |
            dist/extension.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 11. é€šçŸ¥ç»“æœ
      - name: å‘å¸ƒå®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ Chrome æ‰©å±•å‘å¸ƒå®Œæˆï¼"
          echo ""
          echo "ğŸ“Š å‘å¸ƒä¿¡æ¯ï¼š"
          echo "   ç‰ˆæœ¬: ${{ env.VERSION }}"
          echo "   æ‰©å±• ID: ${{ secrets.EXTENSION_ID }}"
          echo "   GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo ""
          echo "ğŸ”— è®¿é—®é“¾æ¥ï¼š"
          echo "   Chrome Web Store: https://chrome.google.com/webstore/detail/${{ secrets.EXTENSION_ID }}"
          echo "   GitHub ä»“åº“: https://github.com/${{ github.repository }}"
          echo ""
          echo "â° æ³¨æ„äº‹é¡¹ï¼š"
          echo "   â€¢ Chrome Web Store å®¡æ ¸é€šå¸¸éœ€è¦å‡ å°æ—¶åˆ°å‡ å¤©æ—¶é—´"
          echo "   â€¢ åœ¨å®¡æ ¸é€šè¿‡ä¹‹å‰ï¼Œæ–°ç‰ˆæœ¬ä¸ä¼šå¯¹å…¬ä¼—å¯è§"
          echo "   â€¢ ä½ å¯ä»¥åœ¨ Chrome Web Store å¼€å‘è€…æ§åˆ¶å°æŸ¥çœ‹å®¡æ ¸çŠ¶æ€"
      
      # 12. é”™è¯¯å¤„ç†
      - name: å‘å¸ƒå¤±è´¥å¤„ç†
        if: failure()
        run: |
          echo "âŒ å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼"
          echo ""
          echo "ğŸ” å¯èƒ½çš„åŸå› ï¼š"
          echo "   â€¢ API å‡­æ®é…ç½®é”™è¯¯"
          echo "   â€¢ ç½‘ç»œè¿æ¥é—®é¢˜"
          echo "   â€¢ Chrome Web Store æœåŠ¡å¼‚å¸¸"
          echo "   â€¢ æ‰©å±•åŒ…æ ¼å¼é—®é¢˜"
          echo ""
          echo "ğŸ›  è§£å†³æ–¹æ¡ˆï¼š"
          echo "   1. æ£€æŸ¥ GitHub Secrets é…ç½®"
          echo "   2. éªŒè¯æ‰©å±• ID æ˜¯å¦æ­£ç¡®"
          echo "   3. ç¡®è®¤ Google API å‡­æ®æœ‰æ•ˆ"
          echo "   4. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—"
          echo ""
          echo "ğŸ“ è·å–å¸®åŠ©ï¼š"
          echo "   â€¢ GitHub Issues: https://github.com/${{ github.repository }}/issues"
          echo "   â€¢ Chrome Web Store æ”¯æŒ: https://support.google.com/chrome_webstore/"
