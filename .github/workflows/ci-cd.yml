name: CI/CD Pipeline

on:
  push:
    branches: [ main, cicd-docker-deploy ]
  pull_request:
    branches: [ main ]

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: read
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: è¿è¡Œæµ‹è¯•
      run: npm test
      
    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥ä»£ç æ ¼å¼..."
        # åŸºç¡€æ£€æŸ¥å·²åœ¨ npm test ä¸­å®Œæˆ
        
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/cicd-docker-deploy'
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•åˆ° Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
  deploy:
    needs: [test, build-and-push]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: è¿æ¥åˆ° Tailscale ç½‘ç»œ
      uses: tailscale/github-action@v2
      with:
        oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
        tags: tag:ci
        hostname: github-actions-${{ github.run_id }}
        
    - name: ç­‰å¾… Tailscale è¿æ¥å»ºç«‹
      run: |
        echo "ç­‰å¾… Tailscale è¿æ¥å»ºç«‹..."
        sleep 5
        tailscale status
        
    - name: éªŒè¯ç›®æ ‡æœåŠ¡å™¨è¿é€šæ€§
      run: |
        echo "éªŒè¯åˆ°ç›®æ ‡æœåŠ¡å™¨çš„è¿æ¥..."
        ping -c 3 ${{ secrets.SERVER_HOST }} || {
          echo "âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ ${{ secrets.SERVER_HOST }}"
          echo "æ£€æŸ¥ Tailscale ç½‘ç»œé…ç½®å’ŒæœåŠ¡å™¨çŠ¶æ€"
          tailscale status
          exit 1
        }
        echo "âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸"
        
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          # ç™»å½•åˆ° GitHub Container Registry
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # åˆ›å»ºä¸´æ—¶éƒ¨ç½²è„šæœ¬
          cat > /tmp/deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          ENVIRONMENT=${1:-production}
          IMAGE_TAG=${2:-latest}
          CONTAINER_NAME="dom-catcher-server"
          IMAGE_NAME="ghcr.io/wedaren/chrome-copy-local"
          
          # ç¡®ä¿ Docker å¯ç”¨
          if ! command -v docker &> /dev/null; then
              echo "âŒ Docker æœªæ‰¾åˆ°ï¼Œå°è¯•å¸¸è§è·¯å¾„..."
              if [ -f "/usr/local/bin/docker" ]; then
                  export PATH="/usr/local/bin:$PATH"
                  echo "âœ… ä½¿ç”¨ /usr/local/bin/docker"
              elif [ -f "/usr/bin/docker" ]; then
                  export PATH="/usr/bin:$PATH"
                  echo "âœ… ä½¿ç”¨ /usr/bin/docker"
              else
                  echo "âŒ æ— æ³•æ‰¾åˆ° Dockerï¼Œè¯·ç¡®ä¿ Docker å·²å®‰è£…"
                  exit 1
              fi
          fi
          
          echo "ğŸ³ Docker ç‰ˆæœ¬: $(docker --version)"
          echo "ğŸš€ å¼€å§‹éƒ¨ç½² DOM Catcher æœåŠ¡å™¨..."
          echo "ç¯å¢ƒ: $ENVIRONMENT"
          echo "é•œåƒ: $IMAGE_NAME:$IMAGE_TAG"
          
          # åœæ­¢ç°æœ‰å®¹å™¨
          echo "â¹ï¸  åœæ­¢ç°æœ‰å®¹å™¨..."
          docker stop $CONTAINER_NAME 2>/dev/null || true
          docker rm $CONTAINER_NAME 2>/dev/null || true
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
          echo "ğŸ” æ£€æµ‹ç³»ç»Ÿæ¶æ„: $(uname -m)"
          
          # å°è¯•æ‹‰å–é•œåƒï¼Œå¦‚æœå¤±è´¥åˆ™æä¾›è§£å†³æ–¹æ¡ˆ
          if ! docker pull $IMAGE_NAME:$IMAGE_TAG; then
              echo "âŒ é•œåƒæ‹‰å–å¤±è´¥"
              echo "ğŸ” å¯èƒ½çš„åŸå› : æ¶æ„ä¸åŒ¹é…"
              echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆ:"
              echo "   1. ç­‰å¾…å¤šæ¶æ„é•œåƒæ„å»ºå®Œæˆ (éœ€è¦é‡æ–°æ¨é€ä»£ç )"
              echo "   2. æˆ–è€…åœ¨ x86_64 æœåŠ¡å™¨ä¸Šéƒ¨ç½²"
              echo "   3. æˆ–è€…æœ¬åœ°æ„å»ºé•œåƒ: docker build -t $IMAGE_NAME:$IMAGE_TAG ."
              
              # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–å¯ç”¨çš„é•œåƒæ ‡ç­¾
              echo "ğŸ” æ£€æŸ¥å¯ç”¨çš„é•œåƒæ ‡ç­¾..."
              docker images | grep "$(echo "$IMAGE_NAME" | cut -d'/' -f2-)" || true
              
              exit 1
          fi
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          echo "ğŸ“ åˆ›å»ºå¿…è¦çš„ç›®å½•..."
          sudo mkdir -p /opt/dom-catcher/captured
          sudo chown -R 1000:1000 /opt/dom-catcher
          
          # è¿è¡Œæ–°å®¹å™¨
          echo "ğŸƒ å¯åŠ¨æ–°å®¹å™¨..."
          docker run -d \
            --name $CONTAINER_NAME \
            --restart unless-stopped \
            -p 3000:3000 \
            -v /opt/dom-catcher/captured:/app/captured \
            -e NODE_ENV=$ENVIRONMENT \
            $IMAGE_NAME:$IMAGE_TAG
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 15
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          if curl -f -s http://localhost:3000/status > /dev/null; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼æœåŠ¡æ­£å¸¸è¿è¡Œ"
              echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
              docker ps | grep $CONTAINER_NAME || true
              echo "ğŸŒ æœåŠ¡åœ°å€: http://localhost:3000"
          else
              echo "âŒ éƒ¨ç½²å¤±è´¥ï¼æœåŠ¡æ— æ³•è®¿é—®"
              echo "ğŸ“ å®¹å™¨æ—¥å¿—:"
              docker logs $CONTAINER_NAME
              echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
              docker ps -a | grep $CONTAINER_NAME || true
              exit 1
          fi
          EOF
          
          # è®¾ç½®è„šæœ¬å¯æ‰§è¡Œæƒé™å¹¶æ‰§è¡Œ
          chmod +x /tmp/deploy.sh
          /tmp/deploy.sh production ${{ needs.build-and-push.outputs.image-tag }}
